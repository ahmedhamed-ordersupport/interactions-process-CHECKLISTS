<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T2 OS Cancellations & Returns Checklist</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0c10; /* Dark background inspired by Tempo */
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #1a1c24; /* Slightly lighter dark for the container */
        }
        /* Custom scrollbar for better aesthetics */
        .task-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .task-list-container::-webkit-scrollbar-track {
            background: #2a2c33;
            border-radius: 10px;
        }
        .task-list-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 10px;
        }
        .task-list-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* Style for the checkbox to make it bigger */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid #5a5a66;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        input[type="checkbox"]:checked {
            background-color: #1d4ed8; /* Tempo blue accent */
            border-color: #1d4ed8;
        }
        input[type="checkbox"]:checked::before {
            content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="16" height="16"><path d="M9.707 14.293L19.414 4.586A2 2 0 0122 6V20a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h12.414l-9.707 9.707a2 2 0 010 2.828l2.586 2.586a2 2 0 012.828 0z" /></svg>');
            display: block;
            position: relative;
            left: 2px;
            top: 2px;
        }
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .delete-btn {
            background-color: #ef4444; /* Red for delete */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>

    <div class="container rounded-lg shadow-xl p-8">
        <div class="flex flex-col items-center justify-center mb-8">
            <div class="flex items-center space-x-4 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-3xl font-bold text-white">T2 OS Cancellations & Returns Checklist</h1>
            </div>
            <p class="text-gray-400 text-center">Your personalized dashboard to create and manage checklists for your team's daily tasks.</p>
        </div>

        <div id="user-info" class="text-sm text-gray-400 mb-4 rounded-md p-2 bg-gray-800 hidden">
            <p>User ID: <span id="user-id" class="font-medium text-gray-200"></span></p>
        </div>

        <div id="loading" class="text-center p-8 text-gray-500 font-medium">
            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Connecting to the dashboard...</p>
        </div>

        <!-- Checklists Section -->
        <div id="checklist-section" class="hidden">
            <div class="mb-6">
                <label for="checklist-selector" class="block text-sm font-medium text-gray-300 mb-2">Select a Process Checklist:</label>
                <select id="checklist-selector" class="block w-full rounded-lg border-2 border-gray-600 bg-gray-800 text-white p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <option value="subscription-cancellation">Subscription Cancellation</option>
                    <option value="returns">Returns</option>
                    <option value="order-cancellations">Order Cancellations</option>
                    <option value="downgrades">Downgrades</option>
                    <option value="sales">Sales</option>
                    <option value="winback-outreach">Winback Outreach</option>
                </select>
            </div>

            <!-- Add new task form -->
            <form id="add-task-form" class="mb-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="new-task-input" placeholder="Add a new task..." class="flex-1 rounded-lg border-2 border-gray-600 bg-gray-800 text-white p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required>
                <button type="submit" class="bg-blue-600 text-white font-semibold rounded-lg p-3 hover:bg-blue-500 transition-colors">Add Task</button>
            </form>

            <div class="bg-gray-800 rounded-lg p-6 max-h-[400px] overflow-y-auto task-list-container">
                <h2 class="text-xl font-semibold text-gray-200 mb-4" id="current-checklist-title">Current Checklist Items</h2>
                <div id="task-list" class="space-y-4">
                    <!-- Checklist items will be dynamically added here -->
                </div>
                <div id="empty-state" class="text-center text-gray-500 p-8 hidden">
                    <p>No checklist items found. Add a new task to get started!</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="message-box text-white"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        
        async function runChecklistApp() {
            // Firebase global variables
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // UI elements
            const checklistSelector = document.getElementById('checklist-selector');
            const taskList = document.getElementById('task-list');
            const addTaskForm = document.getElementById('add-task-form');
            const newTaskInput = document.getElementById('new-task-input');
            const emptyState = document.getElementById('empty-state');
            const currentChecklistTitle = document.getElementById('current-checklist-title');
            const loading = document.getElementById('loading');
            const checklistSection = document.getElementById('checklist-section');
            const messageBox = document.getElementById('message-box');
            const userIdDisplay = document.getElementById('user-id');
            const userInfo = document.getElementById('user-info');
            
            let db, auth;
            let unsubscribe = null;
            let checklists = {};

            const initialChecklists = {
                "subscription-cancellation": [
                    { name: "Resolve call and add VOC and notes to the interaction.", completed: false },
                    { name: "Update the request type of the call interaction before resolving the call.", completed: false },
                    { name: "Send a follow-up email to the customer, recapping or continuing the conversation.", completed: false },
                    { name: "Raise on Slack if the case requires an exception or further assistance from other teams.", completed: false },
                    { name: "Cancel the membership on retool, and if a refund is approved, ensure processing of the refund.", completed: false },
                    { name: "MUST Add NetSuite cards and concession cards if applicable.", completed: false },
                    { name: "Clear detailed notes and update CRM request types if applicable.", completed: false },
                    { name: "Double-check the list and ensure all steps are completed before resolving the ticket.", completed: false }
                ],
                "returns": [
                    { name: "Inspect the returned item upon arrival.", completed: false },
                    { name: "Process the refund according to the policy.", completed: false },
                    { name: "Close the return request in the system.", completed: false }
                ],
                "order-cancellations": [],
                "downgrades": [],
                "sales": [],
                "winback-outreach": []
            };
            
            async function initializeApp() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    const userId = auth.currentUser.uid;
                    userIdDisplay.textContent = userId;
                    userInfo.classList.remove('hidden');

                    const checklistsRef = collection(db, `artifacts/${appId}/public/data/checklists`);
                    
                    // Check and create each initial checklist if it doesn't exist.
                    for (const [key, value] of Object.entries(initialChecklists)) {
                        const docRef = doc(checklistsRef, key);
                        const docSnap = await getDoc(docRef);
                        if (!docSnap.exists()) {
                            await setDoc(docRef, { name: key, tasks: value });
                        }
                    }

                    startListening();

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    showMessage("Failed to connect to the dashboard.", "error");
                }
            }

            function startListening() {
                if (unsubscribe) {
                    unsubscribe();
                }

                const currentChecklistName = checklistSelector.value;
                const docRef = doc(db, `artifacts/${appId}/public/data/checklists/${currentChecklistName}`);
                
                unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        checklists[currentChecklistName] = docSnap.data().tasks || [];
                        renderChecklist();
                    } else {
                        checklists[currentChecklistName] = [];
                        renderChecklist();
                    }
                    loading.classList.add('hidden');
                    checklistSection.classList.remove('hidden');
                }, (error) => {
                    console.error("Error listening to checklist changes:", error);
                    showMessage("Failed to load checklists.", "error");
                });
            }

            function renderChecklist() {
                const currentChecklistName = checklistSelector.value;
                const currentChecklist = checklists[currentChecklistName] || [];
                
                currentChecklistTitle.textContent = `${checklistSelector.options[checklistSelector.selectedIndex].text} Checklist Items`;
                taskList.innerHTML = '';
                
                if (currentChecklist.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    currentChecklist.forEach((task, index) => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item flex items-center p-4 rounded-lg transition-colors relative ${task.completed ? 'bg-gray-700' : 'bg-gray-800 hover:bg-gray-700'}`;
                        if (task.completed) {
                           taskItem.classList.add('completed');
                        }

                        taskItem.innerHTML = `
                            <input type="checkbox" class="task-checkbox" data-index="${index}" ${task.completed ? 'checked' : ''}>
                            <p class="task-text ml-4 text-white text-lg font-medium flex-1">${task.name}</p>
                            <button class="delete-btn ml-4" data-index="${index}">Delete</button>
                        `;
                        
                        taskItem.querySelector('.task-checkbox').addEventListener('change', (e) => {
                            toggleTaskStatus(e.target.dataset.index);
                        });
                        
                        taskItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                            deleteTask(e.target.dataset.index);
                        });

                        taskList.appendChild(taskItem);
                    });
                }
            }

            async function toggleTaskStatus(taskIndex) {
                try {
                    const currentChecklistName = checklistSelector.value;
                    const checklistRef = doc(db, `artifacts/${appId}/public/data/checklists/${currentChecklistName}`);
                    const tasks = checklists[currentChecklistName];
                    tasks[taskIndex].completed = !tasks[taskIndex].completed;
                    await updateDoc(checklistRef, { tasks: tasks });
                    showMessage("Task status updated!");
                } catch (error) {
                    console.error("Error updating task status:", error);
                    showMessage("Failed to update task status.", "error");
                }
            }
            
            async function addTask(e) {
                e.preventDefault();
                const taskName = newTaskInput.value.trim();
                if (!taskName) return;
                
                try {
                    const currentChecklistName = checklistSelector.value;
                    const checklistRef = doc(db, `artifacts/${appId}/public/data/checklists/${currentChecklistName}`);
                    const tasks = checklists[currentChecklistName] || [];
                    const newTasks = [...tasks, { name: taskName, completed: false }];
                    await updateDoc(checklistRef, { tasks: newTasks });
                    newTaskInput.value = '';
                    showMessage("Task added!");
                } catch (error) {
                    console.error("Error adding task:", error);
                    showMessage("Failed to add task.", "error");
                }
            }

            async function deleteTask(taskIndex) {
                try {
                    const currentChecklistName = checklistSelector.value;
                    const checklistRef = doc(db, `artifacts/${appId}/public/data/checklists/${currentChecklistName}`);
                    const tasks = checklists[currentChecklistName];
                    const updatedTasks = tasks.filter((_, index) => index != taskIndex);
                    await updateDoc(checklistRef, { tasks: updatedTasks });
                    showMessage("Task deleted!");
                } catch (error) {
                    console.error("Error deleting task:", error);
                    showMessage("Failed to delete task.", "error");
                }
            }

            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.className = `message-box show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            }

            checklistSelector.addEventListener('change', () => {
                renderChecklist();
                startListening();
            });

            addTaskForm.addEventListener('submit', addTask);
            
            document.addEventListener('DOMContentLoaded', () => {
                initializeApp();
            });
        }

        runChecklistApp();
    </script>
</body>
</html>
